<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
 
 <title>Versal Engineering</title>
 <link href="http://engineering.versal.com/atom.xml" rel="self"/>
 <link href="http://engineering.versal.com"/>
 <updated>2013-04-01T16:15:31-07:00</updated>
 <id>http://engineering.versal.com</id>
 <author>
   <name>Versal</name>
   <email>info@versal.com</email>
 </author>

 
 <entry>
   <title>Integration Testing with Clojure and Clojurescript</title>
   <link href="http://engineering.versal.com/testing/2013/03/07/shuttle-js-jvm-testing"/>
   <updated>2013-03-07T13:11:00-08:00</updated>
   <id>http://engineering.versal.com/testing/2013/03/07/shuttle-js-jvm-testing</id>
   <content type="html">&lt;p&gt;A popular framework for integration testing web apps is Selenium, which programmatically controls a browser to run tests. Selenium has its drawbacks, namely tests can be &lt;a href='http://jdrew33.blogspot.com/2012/02/pros-and-cons-of-selenium.html'&gt;slow, brittle and non-deterministic&lt;/a&gt;. In this post, we&amp;#8217;ll look at an alternative integration testing solution that uses Clojure and Clojurescript.&lt;/p&gt;

&lt;p&gt;The ideal way to do integration testing would be to write tests that can make frontend calls and then verify state changes on the backend. We thought that Clojure (a modern dialect of Lisp that runs on the JVM) and ClojureScript (its Javascript variant) would be good candidates for the test framework since it allows us to use essentially the same language on both the frontend and backend. An added benefit is that the backend can be written in any language that runs on the JVM, and the client code can be Javascript or anything that compiles to Javascript. As an example, Versal&amp;#8217;s stack is primarily Scala and Coffeescript.&lt;/p&gt;

&lt;p&gt;To allow communication between the frontend and the backend, we&amp;#8217;ll use the excellent utility &lt;a href='http://github.com/cemerick/yonder'&gt;cemerick/yonder&lt;/a&gt;. Yonder allows the server to remotely run ClojureScript through an nREPL (network REPL) connection, and includes helper functions for setting up and managing the nREPL connection. When a client first loads the page, it opens a connection to server and then waits for commands.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='clojure'&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;repl/connect&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;http://localhost:9000/repl&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The test suite must create an nREPL endpoint on the server side before it loads the client. Yonder&amp;#8217;s mechanism for doing this is &lt;code&gt;open-session&lt;/code&gt;, which returns a session handle for the REPL it creates. &lt;code&gt;open-session&lt;/code&gt; takes two parameters, &lt;code&gt;:prepare&lt;/code&gt; (function that sets up the client), and &lt;code&gt;:new-server&lt;/code&gt; (a description for the server that acts as the nREPL endpoint). For the prepare function, we&amp;#8217;ll use the default function included with yonder that loads the client page using PhantomJS. For the server, we&amp;#8217;ll use the default nREPL server with an additional middleware that allows ClojureScript evaluation.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='clojure'&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;yonder/open-session&lt;/span&gt;
              &lt;span class='p'&gt;{&lt;/span&gt;&lt;span class='ss'&gt;:prepare&lt;/span&gt; &lt;span class='nv'&gt;yonder/prepare-phantomjs&lt;/span&gt;
               &lt;span class='ss'&gt;:new-server&lt;/span&gt;
               &lt;span class='p'&gt;{&lt;/span&gt;&lt;span class='ss'&gt;:handler&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;server/default-handler&lt;/span&gt;
                           &lt;span class='o'&gt;#&lt;/span&gt;&lt;span class='ss'&gt;&amp;#39;cemerick.piggieback/wrap-cljs-repl&lt;/span&gt;&lt;span class='p'&gt;)}})&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;With the session returned by &lt;code&gt;open-session&lt;/code&gt;, we can now execute ClojureScript on the client remotely from our Clojure server!&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='clojure'&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;yonder/eval&lt;/span&gt; &lt;span class='nv'&gt;session&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;+ &lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt; &lt;span class='mi'&gt;2&lt;/span&gt; &lt;span class='mi'&gt;3&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;yonder/eval&lt;/span&gt; &lt;span class='nv'&gt;session&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;into &lt;/span&gt;&lt;span class='p'&gt;[]&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;js/Array&lt;/span&gt; &lt;span class='ss'&gt;:a&lt;/span&gt; &lt;span class='ss'&gt;&amp;#39;b&lt;/span&gt; &lt;span class='ss'&gt;::c&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;d&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we&amp;#8217;re ready to write our integration tests. For a sample test, let&amp;#8217;s make the client perform an Ajax POST and store the submission on the server. Then we&amp;#8217;ll verify that we received the correct submission.&lt;/p&gt;

&lt;p&gt;Ajax request with some sample data:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='clojure'&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='kd'&gt;defn &lt;/span&gt;&lt;span class='o'&gt;^&lt;/span&gt;&lt;span class='ss'&gt;:export&lt;/span&gt; &lt;span class='nv'&gt;submit&lt;/span&gt; &lt;span class='p'&gt;[]&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;xhr&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='ss'&gt;:post&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;/api/submit&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt;&lt;span class='ss'&gt;:submission&lt;/span&gt; &lt;span class='mi'&gt;42&lt;/span&gt;&lt;span class='p'&gt;}&lt;/span&gt;
       &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='k'&gt;fn &lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;_&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;log&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;Finished submission&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;))))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Compojure route on the server that sets an atom to the value it receives.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='clojure'&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;POST&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;/api/submit&amp;quot;&lt;/span&gt;
                 &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt;&lt;span class='nv'&gt;s&lt;/span&gt; &lt;span class='ss'&gt;:submission&lt;/span&gt;&lt;span class='p'&gt;}&lt;/span&gt; &lt;span class='ss'&gt;:params&lt;/span&gt;&lt;span class='p'&gt;}&lt;/span&gt;
                 &lt;span class='c1'&gt;;; Modify server state&lt;/span&gt;
                 &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;reset!&lt;/span&gt; &lt;span class='nv'&gt;submission&lt;/span&gt; &lt;span class='nv'&gt;s&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So our final test looks like this. Note that the prepare function opens up test.html instead of the default index.html. After we have an nREPL session, we call invoke the ajax call on the client side, wait a few seconds for the request to complete, and verify the result in the atom.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='clojure'&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;deftest&lt;/span&gt; &lt;span class='nv'&gt;browser-test&lt;/span&gt;
         &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;yonder/with-session&lt;/span&gt;
           &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;session&lt;/span&gt;
            &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;yonder/open-session&lt;/span&gt;
              &lt;span class='p'&gt;{&lt;/span&gt;&lt;span class='ss'&gt;:prepare&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;partial &lt;/span&gt;&lt;span class='nv'&gt;yonder/prepare-phantomjs&lt;/span&gt;
                                 &lt;span class='p'&gt;{&lt;/span&gt;&lt;span class='ss'&gt;:url&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;http://localhost:8080/test.html&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;})&lt;/span&gt;
               &lt;span class='ss'&gt;:new-server&lt;/span&gt;
               &lt;span class='p'&gt;{&lt;/span&gt;&lt;span class='ss'&gt;:handler&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;server/default-handler&lt;/span&gt;
                           &lt;span class='o'&gt;#&lt;/span&gt;&lt;span class='ss'&gt;&amp;#39;cemerick.piggieback/wrap-cljs-repl&lt;/span&gt;&lt;span class='p'&gt;)}})]&lt;/span&gt;
           &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;yonder/eval&lt;/span&gt; &lt;span class='nv'&gt;session&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;cljs.test/submit&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
           &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;Thread/sleep&lt;/span&gt; &lt;span class='mi'&gt;4000&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
           &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;is&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;= &lt;/span&gt;&lt;span class='s'&gt;&amp;quot;42&amp;quot;&lt;/span&gt; &lt;span class='o'&gt;@&lt;/span&gt;&lt;span class='nv'&gt;submission&lt;/span&gt;&lt;span class='p'&gt;))))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We can run our test from the command line with &lt;code&gt;lein test&lt;/code&gt;.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;wei:shuttle wei&lt;span class='nv'&gt;$ &lt;/span&gt;lein &lt;span class='nb'&gt;test&lt;/span&gt;

lein &lt;span class='nb'&gt;test &lt;/span&gt;shuttle.core-test
2013-03-06 13:46:34.936:INFO:oejs.Server:jetty-7.6.1.v20120215

Testing shuttle.core-test
2013-03-06 13:46:35.142:INFO:oejs.AbstractConnector:Started SelectChannelConnector@0.0.0.0:8080

Ran 1 tests containing 1 assertions.
0 failures, 0 errors.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Please check out the project at &lt;a href='http://www.github.com/versal/shuttle'&gt;versal/shuttle&lt;/a&gt;!&lt;/p&gt;</content>
 </entry>
 
 <entry>
   <title>Sandbox</title>
   <link href="http://engineering.versal.com/frameworks/2012/11/30/Sandbox-js"/>
   <updated>2012-11-30T17:35:00-08:00</updated>
   <id>http://engineering.versal.com/frameworks/2012/11/30/Sandbox-js</id>
   <content type="html">&lt;p&gt;Sometimes user-provided javascript needs to be run, which is scary (&lt;a href='https://github.com/kitcambridge/evil.js'&gt;Evil.js anybody?&lt;/a&gt;). At first, we tried to sanitize third-party code to make it safe, but this got ugly quickly. It meant that we had to prepend code to every CSS selector to make sure external styles only affected the right elements, the HTML had to always be well-formed, and let&amp;#8217;s not even talk about the JS. It also meant we couldn&amp;#8217;t surface meaningful javascript errors when something went wrong, because it was a small piece of javascript compiled in a larger application. We looked for another solution.&lt;/p&gt;

&lt;p&gt;&lt;a href='http://jsfiddle.net'&gt;JSFiddle&lt;/a&gt; and &lt;a href='http://jsbin.com'&gt;JSBin&lt;/a&gt; seemed to have similar requirements, and handled it using iframes. As frontend developers though, our gut aversion to iframes stopped us from typing the tag into our terminals in good conscience. However, they seemed to work nicely because the scripts couldn&amp;#8217;t touch anything but their box, CSS and JS selectors just worked, and we could monitor errors easily. &lt;a href='http://benvinegar.github.com/seamless-talk/'&gt;This&lt;/a&gt; talk covers more of the benefits of iframes (and it&amp;#8217;s in 3D).&lt;/p&gt;

&lt;p&gt;Although this isn&amp;#8217;t a very common requirement, we built a simple library to handle this which we call &lt;a href='http://github.com/versal/sandbox-js'&gt;Sandbox.js&lt;/a&gt;. It enables a few nice things like importing external JS and CSS as well as stopping code from creating dialogs (alert/confirm/prompt) unless desired. In the near future we hope to add error handling and a nice callback system so the frame can more easily communicate with the parent without nasty globals everywhere.&lt;/p&gt;

&lt;p&gt;Happy Sandboxing!&lt;/p&gt;</content>
 </entry>
 
 <entry>
   <title>Beyond the Reader Monad: Dependency Injection with Jellyfish</title>
   <link href="http://engineering.versal.com/frameworks/2012/11/16/jellyfish-introduction"/>
   <updated>2012-11-16T10:37:00-08:00</updated>
   <id>http://engineering.versal.com/frameworks/2012/11/16/jellyfish-introduction</id>
   <content type="html">&lt;p&gt;One handy use of the reader monad is to build up a program that has a single external dependency which can be provided at the appropriate time.&lt;/p&gt;

&lt;p&gt;In Scala a reader might look something like this:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='scala'&gt;&lt;span class='k'&gt;trait&lt;/span&gt; &lt;span class='nc'&gt;Monad&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;A&lt;/span&gt;, &lt;span class='kt'&gt;F&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='k'&gt;_&lt;/span&gt;&lt;span class='o'&gt;]]&lt;/span&gt; &lt;span class='o'&gt;{&lt;/span&gt;
  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;B&lt;/span&gt;&lt;span class='o'&gt;](&lt;/span&gt;&lt;span class='n'&gt;f&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;A&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;B&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;F&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;B&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;
  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='n'&gt;flatMap&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;B&lt;/span&gt;&lt;span class='o'&gt;](&lt;/span&gt;&lt;span class='n'&gt;f&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;A&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;F&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;B&lt;/span&gt;&lt;span class='o'&gt;])&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;F&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;B&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;
&lt;span class='o'&gt;}&lt;/span&gt;

&lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;Reader&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;E&lt;/span&gt;, &lt;span class='kt'&gt;A&lt;/span&gt;&lt;span class='o'&gt;](&lt;/span&gt;&lt;span class='n'&gt;g&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;E&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;A&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt; &lt;span class='k'&gt;extends&lt;/span&gt; &lt;span class='nc'&gt;Monad&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;A&lt;/span&gt;, &lt;span class='o'&gt;({&lt;/span&gt;&lt;span class='k'&gt;type&lt;/span&gt; &lt;span class='kt'&gt;λ&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;α&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='kt'&gt;=&lt;/span&gt; &lt;span class='kt'&gt;E&lt;/span&gt; &lt;span class='k'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='kt'&gt;α&lt;/span&gt;&lt;span class='o'&gt;})&lt;/span&gt;&lt;span class='k'&gt;#&lt;/span&gt;&lt;span class='kt'&gt;λ&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='o'&gt;{&lt;/span&gt;
  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='n'&gt;apply&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;e&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;E&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;A&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;g&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;e&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;
  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;B&lt;/span&gt;&lt;span class='o'&gt;](&lt;/span&gt;&lt;span class='n'&gt;f&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;A&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;B&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;E&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;B&lt;/span&gt; &lt;span class='k'&gt;=&lt;/span&gt; &lt;span class='o'&gt;{&lt;/span&gt; &lt;span class='n'&gt;e&lt;/span&gt; &lt;span class='k'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;f&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;g&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;e&lt;/span&gt;&lt;span class='o'&gt;))&lt;/span&gt; &lt;span class='o'&gt;}&lt;/span&gt;
  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='n'&gt;flatMap&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;B&lt;/span&gt;&lt;span class='o'&gt;](&lt;/span&gt;&lt;span class='n'&gt;f&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;A&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;E&lt;/span&gt; &lt;span class='k'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;B&lt;/span&gt;&lt;span class='o'&gt;))&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;E&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;B&lt;/span&gt; &lt;span class='k'&gt;=&lt;/span&gt; &lt;span class='o'&gt;{&lt;/span&gt; &lt;span class='n'&gt;e&lt;/span&gt; &lt;span class='k'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;f&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;g&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;e&lt;/span&gt;&lt;span class='o'&gt;))(&lt;/span&gt;&lt;span class='n'&gt;e&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt; &lt;span class='o'&gt;}&lt;/span&gt;
&lt;span class='o'&gt;}&lt;/span&gt;

&lt;span class='k'&gt;object&lt;/span&gt; &lt;span class='nc'&gt;Reader&lt;/span&gt; &lt;span class='o'&gt;{&lt;/span&gt;
  &lt;span class='k'&gt;implicit&lt;/span&gt; &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='n'&gt;function1ToReader&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;E&lt;/span&gt;, &lt;span class='kt'&gt;A&lt;/span&gt;&lt;span class='o'&gt;](&lt;/span&gt;&lt;span class='n'&gt;g&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;E&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;A&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Reader&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;E&lt;/span&gt;, &lt;span class='kt'&gt;A&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='k'&gt;=&lt;/span&gt; &lt;span class='k'&gt;new&lt;/span&gt; &lt;span class='nc'&gt;Reader&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;g&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;
&lt;span class='o'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We can use this to compose a program from parts which each depend on the same external context:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='scala'&gt;&lt;span class='k'&gt;import&lt;/span&gt; &lt;span class='nn'&gt;scala.xml.NodeSeq&lt;/span&gt;
&lt;span class='k'&gt;import&lt;/span&gt; &lt;span class='nn'&gt;Reader.function1ToReader&lt;/span&gt;

&lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;htmlHeader&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;String&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='nc'&gt;NodeSeq&lt;/span&gt; &lt;span class='k'&gt;=&lt;/span&gt;
  &lt;span class='o'&gt;{&lt;/span&gt; &lt;span class='n'&gt;title&lt;/span&gt; &lt;span class='k'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='o'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;head&lt;/span&gt;&lt;span class='o'&gt;&amp;gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;title&lt;/span&gt;&lt;span class='o'&gt;&amp;gt;{&lt;/span&gt;&lt;span class='n'&gt;title&lt;/span&gt;&lt;span class='o'&gt;}&amp;lt;/&lt;/span&gt;&lt;span class='n'&gt;title&lt;/span&gt;&lt;span class='o'&gt;&amp;gt;&amp;lt;/&lt;/span&gt;&lt;span class='n'&gt;head&lt;/span&gt;&lt;span class='o'&gt;&amp;gt;&lt;/span&gt; &lt;span class='o'&gt;}&lt;/span&gt;

&lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;htmlBody&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;String&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='nc'&gt;NodeSeq&lt;/span&gt; &lt;span class='k'&gt;=&lt;/span&gt;
  &lt;span class='o'&gt;{&lt;/span&gt; &lt;span class='n'&gt;title&lt;/span&gt; &lt;span class='k'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='o'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;body&lt;/span&gt;&lt;span class='o'&gt;&amp;gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;h1&lt;/span&gt;&lt;span class='o'&gt;&amp;gt;{&lt;/span&gt;&lt;span class='n'&gt;title&lt;/span&gt;&lt;span class='o'&gt;}&amp;lt;/&lt;/span&gt;&lt;span class='n'&gt;h1&lt;/span&gt;&lt;span class='o'&gt;&amp;gt;&amp;lt;/&lt;/span&gt;&lt;span class='n'&gt;body&lt;/span&gt;&lt;span class='o'&gt;&amp;gt;&lt;/span&gt; &lt;span class='o'&gt;}&lt;/span&gt;

&lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;html&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;NodeSeq&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='nc'&gt;NodeSeq&lt;/span&gt; &lt;span class='k'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='nc'&gt;NodeSeq&lt;/span&gt; &lt;span class='k'&gt;=&lt;/span&gt;
  &lt;span class='o'&gt;{&lt;/span&gt; &lt;span class='n'&gt;header&lt;/span&gt; &lt;span class='k'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;body&lt;/span&gt; &lt;span class='k'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='o'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;html&lt;/span&gt;&lt;span class='o'&gt;&amp;gt;{&lt;/span&gt;&lt;span class='n'&gt;header&lt;/span&gt;&lt;span class='o'&gt;}{&lt;/span&gt;&lt;span class='n'&gt;body&lt;/span&gt;&lt;span class='o'&gt;}&amp;lt;/&lt;/span&gt;&lt;span class='n'&gt;html&lt;/span&gt;&lt;span class='o'&gt;&amp;gt;&lt;/span&gt; &lt;span class='o'&gt;}&lt;/span&gt;

&lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;pageFromTitle&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Reader&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;String&lt;/span&gt;, &lt;span class='kt'&gt;NodeSeq&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='k'&gt;=&lt;/span&gt;
  &lt;span class='k'&gt;for&lt;/span&gt; &lt;span class='o'&gt;{&lt;/span&gt;
    &lt;span class='n'&gt;header&lt;/span&gt; &lt;span class='k'&gt;&amp;lt;-&lt;/span&gt; &lt;span class='n'&gt;htmlHeader&lt;/span&gt;
    &lt;span class='n'&gt;body&lt;/span&gt;   &lt;span class='k'&gt;&amp;lt;-&lt;/span&gt; &lt;span class='n'&gt;htmlBody&lt;/span&gt;
    &lt;span class='n'&gt;page&lt;/span&gt;   &lt;span class='k'&gt;=&lt;/span&gt;  &lt;span class='n'&gt;html&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;header&lt;/span&gt;&lt;span class='o'&gt;)(&lt;/span&gt;&lt;span class='n'&gt;body&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;
  &lt;span class='o'&gt;}&lt;/span&gt; &lt;span class='k'&gt;yield&lt;/span&gt; &lt;span class='n'&gt;page&lt;/span&gt; &lt;span class='c1'&gt;// a program which, given a title, produces an HTML page&lt;/span&gt;

&lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;page&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;NodeSeq&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;pageFromTitle&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;Reader Example&amp;quot;&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;
&lt;span class='n'&gt;println&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;page&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt; &lt;span class='c1'&gt;// &amp;lt;html&amp;gt;&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;Reader Example&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body&amp;gt; ...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id='the_problem'&gt;The problem&lt;/h2&gt;

&lt;p&gt;This is an easy way to do dependency injection, but it has a drawback: the dependency has to be a single thing. This makes it hard to build a program from components that have different depenencies.&lt;/p&gt;

&lt;p&gt;Consider if we change &lt;code&gt;htmlBody&lt;/code&gt; to take a &lt;code&gt;Date&lt;/code&gt; instead of a &lt;code&gt;String&lt;/code&gt;:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='scala'&gt;&lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;htmlBody&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Date&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='nc'&gt;NodeSeq&lt;/span&gt; &lt;span class='k'&gt;=&lt;/span&gt; &lt;span class='n'&gt;date&lt;/span&gt; &lt;span class='k'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='o'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;body&lt;/span&gt;&lt;span class='o'&gt;&amp;gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;h1&lt;/span&gt;&lt;span class='o'&gt;&amp;gt;{&lt;/span&gt;&lt;span class='n'&gt;date&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;toString&lt;/span&gt;&lt;span class='o'&gt;}&amp;lt;/&lt;/span&gt;&lt;span class='n'&gt;h1&lt;/span&gt;&lt;span class='o'&gt;&amp;gt;&amp;lt;/&lt;/span&gt;&lt;span class='n'&gt;body&lt;/span&gt;&lt;span class='o'&gt;&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The for expression above will no longer compile, because the reader is an instance of &lt;code&gt;Reader[String, NodeSeq]&lt;/code&gt;, so both its &lt;code&gt;map&lt;/code&gt; and &lt;code&gt;flatMap&lt;/code&gt; methods expect to be passed a function which takes a &lt;code&gt;String&lt;/code&gt;, not a &lt;code&gt;Date&lt;/code&gt;:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='scala'&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;error&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;  &lt;span class='n'&gt;found&lt;/span&gt;   &lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;java.util.Date&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;scala&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;xml&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='nc'&gt;NodeSeq&lt;/span&gt;
&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;error&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;  &lt;span class='n'&gt;required&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;String&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='o'&gt;?&lt;/span&gt;
&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;error&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;   &lt;span class='n'&gt;body&lt;/span&gt;   &lt;span class='k'&gt;&amp;lt;-&lt;/span&gt; &lt;span class='n'&gt;htmlBody&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id='the_solution'&gt;The solution&lt;/h2&gt;

&lt;p&gt;What we really want is a way to construct a program, and keep track of all the different dependencies as we go. At the end, we&amp;#8217;ll have a sort of arbitrary-order curried function that we can interpret recursively, providing each dependency as needed.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='scala'&gt;&lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;simpleProgram&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Program&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt;
  &lt;span class='n'&gt;program&lt;/span&gt; &lt;span class='o'&gt;{&lt;/span&gt;
    &lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;bar&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Bar&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;read&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;Bar&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='c1'&gt;// retrieve the `Bar` dependency&lt;/span&gt;
    &lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;foo&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Foo&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;read&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;Foo&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='c1'&gt;// retrieve the `Foo` dependency&lt;/span&gt;
    &lt;span class='nc'&gt;Return&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;foo is &amp;quot;&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='n'&gt;foo&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;, bar is &amp;quot;&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='n'&gt;bar&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;
  &lt;span class='o'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This is what Jellyfish gives us.&lt;/p&gt;

&lt;h2 id='how_it_works'&gt;How it works&lt;/h2&gt;

&lt;p&gt;A Jellyfish program is represented as an instance of the &lt;code&gt;Program&lt;/code&gt; trait, which has two implementations:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='scala'&gt;&lt;span class='k'&gt;case&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;Return&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;a&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Any&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt; &lt;span class='k'&gt;extends&lt;/span&gt; &lt;span class='nc'&gt;Program&lt;/span&gt;
&lt;span class='k'&gt;case&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;With&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;A&lt;/span&gt;&lt;span class='o'&gt;](&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Class&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;A&lt;/span&gt;&lt;span class='o'&gt;],&lt;/span&gt; &lt;span class='n'&gt;f&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;A&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='nc'&gt;Program&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt; &lt;span class='k'&gt;extends&lt;/span&gt; &lt;span class='nc'&gt;Program&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;code&gt;read&lt;/code&gt; function, which wraps Scala&amp;#8217;s &lt;code&gt;shift&lt;/code&gt; function, takes a generic function of type &lt;code&gt;A =&amp;gt; Program&lt;/code&gt; and wraps it in a &lt;code&gt;With&lt;/code&gt; which tracks the type of &lt;code&gt;A&lt;/code&gt;. This can happen an arbitrary number of times, resulting in a data structure analogous to a curried function.&lt;/p&gt;

&lt;p&gt;Ignoring some of the wrappers, this:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='scala'&gt;&lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;bar&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Bar&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;read&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;Bar&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='c1'&gt;// retrieve the `Bar` dependency&lt;/span&gt;
&lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;foo&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Foo&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;read&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;Foo&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='c1'&gt;// retrieve the `Foo` dependency&lt;/span&gt;
&lt;span class='nc'&gt;Return&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;foo is &amp;quot;&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='n'&gt;foo&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;, bar is &amp;quot;&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='n'&gt;bar&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;becomes:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='scala'&gt;&lt;span class='n'&gt;bar&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Bar&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='o'&gt;{&lt;/span&gt;
  &lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;foo&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Foo&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;read&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;Foo&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='c1'&gt;// retrieve the `Foo` dependency&lt;/span&gt;
  &lt;span class='nc'&gt;Return&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;foo is &amp;quot;&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='n'&gt;foo&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;, bar is &amp;quot;&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='n'&gt;bar&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;
&lt;span class='o'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;which becomes:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='scala'&gt;&lt;span class='n'&gt;bar&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Bar&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='o'&gt;{&lt;/span&gt;
  &lt;span class='n'&gt;foo&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Foo&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='o'&gt;{&lt;/span&gt;
    &lt;span class='nc'&gt;Return&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;foo is &amp;quot;&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='n'&gt;foo&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;, bar is &amp;quot;&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='n'&gt;bar&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;
  &lt;span class='o'&gt;}&lt;/span&gt;
&lt;span class='o'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;which is a curried function with two dependencies.&lt;/p&gt;

&lt;p&gt;An interpreter is then built to unwrap each nested &lt;code&gt;With&lt;/code&gt;, extract the function of type &lt;code&gt;A =&amp;gt; Program&lt;/code&gt;, provide the appropriate instance of &lt;code&gt;A&lt;/code&gt;, and continue until the program completes with a &lt;code&gt;Return&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id='an_example'&gt;An example&lt;/h2&gt;

&lt;p&gt;First, write a program which retrieves dependencies via the &lt;code&gt;read&lt;/code&gt; function:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='scala'&gt;&lt;span class='k'&gt;case&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;Foo&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Int&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;
&lt;span class='k'&gt;case&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;Bar&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;String&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;

&lt;span class='k'&gt;object&lt;/span&gt; &lt;span class='nc'&gt;SimpleProgram&lt;/span&gt; &lt;span class='o'&gt;{&lt;/span&gt;

  &lt;span class='k'&gt;import&lt;/span&gt; &lt;span class='nn'&gt;com.versal.jellyfish.&lt;/span&gt;&lt;span class='o'&gt;{&lt;/span&gt;&lt;span class='n'&gt;program&lt;/span&gt;&lt;span class='o'&gt;,&lt;/span&gt; &lt;span class='nc'&gt;Program&lt;/span&gt;&lt;span class='o'&gt;,&lt;/span&gt; &lt;span class='n'&gt;read&lt;/span&gt;&lt;span class='o'&gt;,&lt;/span&gt; &lt;span class='nc'&gt;Return&lt;/span&gt;&lt;span class='o'&gt;}&lt;/span&gt;

  &lt;span class='c1'&gt;// create a program with some dependencies&lt;/span&gt;
  &lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;simpleProgram&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Program&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt;
   &lt;span class='n'&gt;program&lt;/span&gt; &lt;span class='o'&gt;{&lt;/span&gt;
      &lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;bar&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Bar&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;read&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;Bar&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='c1'&gt;// retrieve the `Bar` dependency&lt;/span&gt;
      &lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;foo&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Foo&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;read&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;Foo&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='c1'&gt;// retrieve the `Foo` dependency&lt;/span&gt;
      &lt;span class='nc'&gt;Return&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;foo is &amp;quot;&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='n'&gt;foo&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;, bar is &amp;quot;&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='n'&gt;bar&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;
    &lt;span class='o'&gt;}&lt;/span&gt;

&lt;span class='o'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Second, write an interpreter which provides the dependencies to the program:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='scala'&gt;&lt;span class='k'&gt;object&lt;/span&gt; &lt;span class='nc'&gt;SimpleInterpreter&lt;/span&gt; &lt;span class='o'&gt;{&lt;/span&gt;

  &lt;span class='k'&gt;import&lt;/span&gt; &lt;span class='nn'&gt;com.versal.jellyfish.&lt;/span&gt;&lt;span class='o'&gt;{&lt;/span&gt;&lt;span class='n'&gt;classy&lt;/span&gt;&lt;span class='o'&gt;,&lt;/span&gt; &lt;span class='nc'&gt;Program&lt;/span&gt;&lt;span class='o'&gt;,&lt;/span&gt; &lt;span class='nc'&gt;Return&lt;/span&gt;&lt;span class='o'&gt;,&lt;/span&gt; &lt;span class='nc'&gt;With&lt;/span&gt;&lt;span class='o'&gt;}&lt;/span&gt;

  &lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;foo&lt;/span&gt; &lt;span class='k'&gt;=&lt;/span&gt; &lt;span class='nc'&gt;Foo&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='mi'&gt;42&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;
  &lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;bar&lt;/span&gt; &lt;span class='k'&gt;=&lt;/span&gt; &lt;span class='nc'&gt;Bar&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;baz&amp;quot;&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;

  &lt;span class='c1'&gt;// run a program, injecting dependencies as needed&lt;/span&gt;
  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='n'&gt;run&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;p&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Program&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;&lt;span class='k'&gt;:&lt;/span&gt; &lt;span class='kt'&gt;Any&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt;
    &lt;span class='n'&gt;p&lt;/span&gt; &lt;span class='k'&gt;match&lt;/span&gt; &lt;span class='o'&gt;{&lt;/span&gt;
      &lt;span class='k'&gt;case&lt;/span&gt; &lt;span class='nc'&gt;With&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;,&lt;/span&gt; &lt;span class='n'&gt;f&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt; &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;isA&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;Foo&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='k'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;run&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;f&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;foo&lt;/span&gt;&lt;span class='o'&gt;))&lt;/span&gt; &lt;span class='c1'&gt;// inject the `Foo` dependency&lt;/span&gt;
      &lt;span class='k'&gt;case&lt;/span&gt; &lt;span class='nc'&gt;With&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;,&lt;/span&gt; &lt;span class='n'&gt;f&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt; &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;isA&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='kt'&gt;Bar&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='k'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;run&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;f&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;bar&lt;/span&gt;&lt;span class='o'&gt;))&lt;/span&gt; &lt;span class='c1'&gt;// inject the `Bar` dependency&lt;/span&gt;
      &lt;span class='k'&gt;case&lt;/span&gt; &lt;span class='nc'&gt;Return&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;a&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;                &lt;span class='k'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;a&lt;/span&gt;           &lt;span class='c1'&gt;// all done - return the result&lt;/span&gt;
    &lt;span class='o'&gt;}&lt;/span&gt;

&lt;span class='o'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Third, run the interpreter:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='scala'&gt;&lt;span class='k'&gt;val&lt;/span&gt; &lt;span class='n'&gt;result&lt;/span&gt; &lt;span class='k'&gt;=&lt;/span&gt; &lt;span class='nc'&gt;SimpleInterpreter&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;run&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='nc'&gt;SimpleProgram&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;simpleProgram&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt;
&lt;span class='n'&gt;println&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;result&lt;/span&gt;&lt;span class='o'&gt;)&lt;/span&gt; &lt;span class='c1'&gt;// prints &amp;quot;foo is 42, bar is baz&amp;quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id='use_it'&gt;Use it&lt;/h2&gt;

&lt;p&gt;Jellyfish lives on GitHub at &lt;a href='https://github.com/Versal/jellyfish'&gt;github.com/Versal/jellyfish&lt;/a&gt;. To use it in your own project, &lt;a href='http://www.scala-sbt.org/release/docs/Detailed-Topics/Compiler-Plugins.html#continuations-plugin-example'&gt;enable continuations&lt;/a&gt; and add the Jellyfish library to your &lt;em&gt;build.sbt&lt;/em&gt; file:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='scala'&gt;&lt;span class='n'&gt;libraryDependencies&lt;/span&gt; &lt;span class='o'&gt;+=&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;com.versal&amp;quot;&lt;/span&gt; &lt;span class='o'&gt;%%&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;jellyfish&amp;quot;&lt;/span&gt; &lt;span class='o'&gt;%&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;0.1-RC1&amp;quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content>
 </entry>
 
 <entry>
   <title>A performance shootout for RESTful libraries</title>
   <link href="http://engineering.versal.com/frameworks/2012/11/07/engineering-at-versal"/>
   <updated>2012-11-07T17:38:00-08:00</updated>
   <id>http://engineering.versal.com/frameworks/2012/11/07/engineering-at-versal</id>
   <content type="html">&lt;p&gt;One of our early projects at Versal was building a thin RESTful API on top of our Scala-based platform. This would allow access to backend services by rich frontend applications, and establish conventions for data and service contracts among our systems.&lt;/p&gt;

&lt;p&gt;Initially we went with a Play 2.0 and Swagger implementation, but its configuration felt unweildy, and the bulk of its feature set was unnecessary for just a simple RESTful API. At this point we stepped back to survey the landscape.&lt;/p&gt;

&lt;p&gt;Some of us had experience with RESTful Java libraries such as Jersey, Spring MVC, Struts, etc., while others had used Scala libraries such as Scalatra and Spray. It was apparent that we needed to cast a wide net and compare what we found, so we created the &lt;a href='http://github.com/Versal/scamper'&gt;Scamper&lt;/a&gt; project.&lt;/p&gt;

&lt;p&gt;Scamper pits several libraries against each other:&lt;/p&gt;

&lt;p&gt;&lt;img alt='Fast Test' src='https://raw.github.com/Versal/scamper/master/readme/fast-test.png' /&gt;&lt;/p&gt;

&lt;p&gt;We made our best guesses to configure each project in a comparable way, and designed both non-blocking &amp;#8220;fast&amp;#8221; tests and blocking &amp;#8220;slow&amp;#8221; tests for each using both ApacheBench and JMeter.&lt;/p&gt;

&lt;p&gt;Based on initial analysis, the fastest implementation uses raw Servlet 3.0. Play 2.0 was somewhat disappointing, but Scalatra turns out to be a nice tradeoff between performance and implementation simplicity. We decided to go with Scalatra.&lt;/p&gt;

&lt;p&gt;We have had good input from the community on how to optimize Play 2.0, yielding significant performance improvements. We look forward to learning more about each approach!&lt;/p&gt;</content>
 </entry>
 
 
</feed>